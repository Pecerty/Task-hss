
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hss Team – Utente</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    nav a { margin-right: 1rem; }
    .done { text-decoration: line-through; color: #888; }
  </style>
</head>
<body>
  <h1>Pagina personale</h1>
  <nav>
    <a href="/user.html?utente=Mary">Mary</a>
    <a href="/user.html?utente=Giovanni">Giovanni</a>
    <a href="/user.html?utente=Peppe">Peppe</a>
    <a href="/user.html?utente=Cristina">Cristina</a>
    <a href="/user.html?utente=Edoardo">Edoardo</a>
    <a href="/user.html?utente=Manutentore">Manutentore</a>
    <a href="/user.html?utente=Vittoria">Vittoria</a>
  </nav>
  <form id="taskForm">
    <input name="nome" placeholder="Nome task" required>
    <select name="priorita">
      <option value="Alta">Alta</option>
      <option value="Media">Media</option>
      <option value="Bassa">Bassa</option>
    </select>
    <select name="assegnato">
      <option>Mary</option><option>Giovanni</option><option>Peppe</option>
      <option>Cristina</option><option>Edoardo</option><option>Manutentore</option><option>Vittoria</option>
    </select>
    <input name="data" type="date" required>
    <button>Aggiungi</button>
  </form>
  <ul id="lista"></ul>
  <script>
    async function carica() {
      const r = await fetch('/api/tasks');
      const tasks = await r.json();
      const ul = document.getElementById('lista');
      ul.innerHTML = "";
      tasks.forEach(t => {
        const li = document.createElement("li");
        li.innerHTML = `<b>${t.nome}</b> – ${t.priorita} – <i>${t.assegnato}</i> – ${t.data}` + (t.fatto ? " ✅" : "");
        if(t.fatto) li.classList.add("done");
        ul.appendChild(li);
      });
    }
    
    const params = new URLSearchParams(location.search);
    const utente = params.get("utente");
    carica();

    async function carica() {
      const r = await fetch('/api/tasks');
      const tasks = await r.json();
      const ul = document.getElementById('lista');
      ul.innerHTML = "";
      tasks.forEach(t => {
        const visibile = t.assegnato === utente ||
            (utente === 'Peppe' && (t.assegnato === 'Peppe' || t.assegnato === 'Manutentore' || t.assegnato === 'Vittoria')) ||
            (utente === 'Giovanni' && (t.assegnato === 'Giovanni' || t.assegnato === 'Vittoria')) ||
            (utente === 'Cristina' && (t.assegnato === 'Cristina' || t.assegnato === 'Vittoria')) ||
            (utente === 'Edoardo' && (t.assegnato === 'Edoardo' || t.assegnato === 'Manutentore'));
        if (!visibile) return;
        const li = document.createElement("li");
        li.innerHTML = `<input type="checkbox" ${t.fatto ? "checked" : ""} onchange="fatto('${t.nome}')"> ` +
                       `<b>${t.nome}</b> – ${t.priorita} – <i>${t.assegnato}</i> – ${t.data}`;
        if(t.fatto) li.classList.add("done");
        ul.appendChild(li);
      });
    }

    async function fatto(nome) {
      const r = await fetch("/api/tasks");
      const tasks = await r.json();
      const idx = tasks.findIndex(t => t.nome === nome);
      if (idx >= 0) {
        tasks[idx].fatto = !tasks[idx].fatto;
        await fetch("/api/overwrite", {
          method: "POST",
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(tasks)
        });
        carica();
      }
    }

    document.getElementById("taskForm").onsubmit = async e => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const task = Object.fromEntries(fd.entries());
      task.fatto = false;
      await fetch("/api/tasks", {
        method: "POST",
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(task)
      });
      e.target.reset();
      
    const params = new URLSearchParams(location.search);
    const utente = params.get("utente");
    carica();

    async function carica() {
      const r = await fetch('/api/tasks');
      const tasks = await r.json();
      const ul = document.getElementById('lista');
      ul.innerHTML = "";
      tasks.forEach(t => {
        const visibile = t.assegnato === utente ||
            (utente === 'Peppe' && (t.assegnato === 'Peppe' || t.assegnato === 'Manutentore' || t.assegnato === 'Vittoria')) ||
            (utente === 'Giovanni' && (t.assegnato === 'Giovanni' || t.assegnato === 'Vittoria')) ||
            (utente === 'Cristina' && (t.assegnato === 'Cristina' || t.assegnato === 'Vittoria')) ||
            (utente === 'Edoardo' && (t.assegnato === 'Edoardo' || t.assegnato === 'Manutentore'));
        if (!visibile) return;
        const li = document.createElement("li");
        li.innerHTML = `<input type="checkbox" ${t.fatto ? "checked" : ""} onchange="fatto('${t.nome}')"> ` +
                       `<b>${t.nome}</b> – ${t.priorita} – <i>${t.assegnato}</i> – ${t.data}`;
        if(t.fatto) li.classList.add("done");
        ul.appendChild(li);
      });
    }

    async function fatto(nome) {
      const r = await fetch("/api/tasks");
      const tasks = await r.json();
      const idx = tasks.findIndex(t => t.nome === nome);
      if (idx >= 0) {
        tasks[idx].fatto = !tasks[idx].fatto;
        await fetch("/api/overwrite", {
          method: "POST",
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(tasks)
        });
        carica();
      }
    }

    };
  </script>
</body>
</html>
